<div class="min-h-screen bg-slate-900 p-2 sm:p-8 text-white">
  @if (clanResult$ | async; as clanResult) {

    <div class="max-w-5xl mx-auto space-y-8">
      
      <div class="bg-slate-800 rounded-xl shadow-2xl border-2 sm:border-4 border-slate-700">
        <div class="bg-linear-to-b from-yellow-400 to-yellow-600 px-4 py-3 border-b-4 border-yellow-700 flex justify-between items-center rounded-t-lg">
          <h2 class="text-xl sm:text-3xl font-black text-blue-900 uppercase tracking-tight">
            Guinea Guns: {{ clanResult.currentMemberCount }}/50
          </h2>
          <span class="text-sm sm:text-lg text-blue-900 font-bold">
            Updated: {{ getRelativeTime(lastFetch!) }}
          </span>
        </div>
        
        @if (activeMembers$ | async; as active) {
          <ng-container *ngTemplateOutlet="memberList; context: { members: active }"></ng-container>
        }
      </div>

      @if (historicalMembers$ | async; as historical) {
        @if (historical.length > 0) {
          <div class="bg-slate-800 rounded-xl border-2 border-slate-700 opacity-90">
            <div class="bg-linear-to-b from-yellow-400 to-yellow-600 px-4 py-3 border-b-4 border-yellow-700 flex justify-between items-center">
              <h3 class="text-xl sm:text-3xl font-black text-blue-900 uppercase tracking-tight">
                Past Members ({{ historical.length }})
              </h3>
            </div>
            <ng-container *ngTemplateOutlet="memberList; context: { members: historical }"></ng-container>
          </div>
        }
      }
    </div>

    <ng-template #memberList let-members="members">
      <div class="hidden md:block overflow-auto max-h-[80vh]">
        <table class="w-full text-left border-separate border-spacing-0">
          <thead>
            <tr class="text-slate-400 uppercase text-[12px] font-black tracking-wider">
              <th class="sticky top-0 z-20 bg-slate-900 p-2 border-b-2 border-slate-700">Member</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-b-2 border-slate-700">Trophies</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-l border-b-2 border-slate-700">W ‚Üë</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-b-2 border-slate-700">W-1</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-b-2 border-slate-700">W-2</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-l border-b-2 border-slate-700">Don</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-b-2 border-slate-700">Joins</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-b-2 border-slate-700">Joined</th>
              <th class="sticky top-0 z-20 bg-slate-900 p-2 text-center border-b-2 border-slate-700">Last Seen</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-700/50">
            @for (member of members; track member.tag) {
              <tr class="hover:bg-slate-700/30 transition-colors group"
                  [class.bg-slate-800]="!member.historical"
                  [class.bg-gray-900]="member.historical">
                
                <td class="p-2 border-l-4 transition-colors"
                    [class.border-transparent]="!member.shouldKick && !member.shouldNudge"
                    [class.border-orange-500]="member.shouldKick"
                    [class.border-yellow-500]="member.shouldNudge">
                  <div class="font-bold text-sm group-hover:text-yellow-400 transition-colors"
                      [class.text-slate-400]="member.historical">
                    {{ member.name }}
                  </div>
                </td>

                <td class="p-2 text-center">
                  <span class="text-xs font-bold text-yellow-500">üèÜ{{ member.trophies }}</span>
                </td>

                @for (war of [member.currentWar, member.lastWar, member.lastLastWar]; track $index) {
                  <td class="p-2 w-24 text-center font-mono text-xs font-bold"
                      [class.border-l]=" $index === 0 "
                      [class.border-slate-700]=" $index === 0 "
                      [class.text-green-400]="war?.warEval == 0"
                      [class.text-red-400]="war?.warEval == 1"
                      [class.text-slate-500]="getFameText(war) == 'N/A'">
                    {{ getFameText(war) }}@if (isPartialParticipation(war)) {<span class="text-slate-500 ml-1">{{ getActiveWarDays(war) }}</span>}
                  </td>
                }

                <td class="p-2 text-center font-mono text-xs font-bold border-l border-slate-700/50"
                    [class.text-green-400]="member.donationEval == 0"
                    [class.text-red-400]="member.donationEval == 1">
                  {{ member.donations }}
                </td>

                <td class="p-2 text-center text-[10px] font-semibold text-slate-400 uppercase">{{ member.joinCount }}</td>
                <td class="p-2 text-center text-[10px] font-semibold uppercase"
                    [class.text-yellow-400]="member.newlyJoined"
                    [class.text-slate-400]="!member.newlyJoined">
                  {{ getRelativeTime(member.earliestMembershipTimestamp) }}
                </td>
                <td class="p-2 text-center text-[10px] font-semibold text-blue-400 uppercase">
                  {{ getRelativeTime(member.lastSeenParsed) }}
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="md:hidden">
        <div class="sticky top-0 z-30 bg-slate-900 border-b-2 border-slate-700 py-2 shadow-xl">
          <div class="flex items-center gap-2 px-1">
            <div class="flex-1">
              <span class="text-[12px] font-bold uppercase pl-2">Member</span>
            </div>
            
            <div class="shrink-0">
              <div class="flex gap-x-1 text-center font-mono">
                <div class="w-14 border-l border-slate-700/50 ml-1 text-[12px] font-black">W‚Üë</div>
                <div class="w-14 text-[12px] font-black">W-1</div>
                <div class="w-14 text-[12px] font-black">W-2</div>
                <div class="w-12 border-l border-slate-700/50 ml-1 text-[12px] font-black">DON</div>
              </div>
            </div>
          </div>
        </div>

        <div class="divide-y divide-slate-700/50">
          @for (member of members; track member.tag) {
            <div class="p-1 flex items-center gap-2 transition-colors"
                [class.bg-slate-800]="!member.historical"
                [class.bg-gray-900]="member.historical"
                [class.border-l-4]="member.shouldKick || member.shouldNudge || member.newlyJoined"
                [class.border-orange-500]="member.shouldKick"
                [class.border-yellow-500]="member.shouldNudge">
              
              <div class="flex-1 min-w-0 flex flex-col gap-1 py-0.5">
                <div class="flex items-center gap-2">
                  <span class="font-bold text-sm truncate active:whitespace-normal active:overflow-visible active:z-50" 
                        [class.text-slate-400]="member.historical">
                    {{ member.name }}
                  </span>
                  <span class="text-[12px] text-yellow-500 font-medium shrink-0">üèÜ{{ member.trophies }}</span>
                </div>

                <div class="flex gap-2 text-[9px] uppercase tracking-tighter text-slate-400 font-semibold">
                  <span class="text-blue-400">S: {{ getRelativeTime(member.lastSeenParsed) }}</span>
                  <span [class.text-yellow-400]="member.newlyJoined">J: {{ getRelativeTime(member.earliestMembershipTimestamp) }}</span>
                  <span>JC: {{ member.joinCount }}</span>
                </div>
              </div>

              <div class="shrink-0 border-l border-slate-700/50">
                <div class="flex gap-x-1 text-center font-mono">
                  @for (war of [member.currentWar, member.lastWar, member.lastLastWar]; track $index) {
                    <div class="w-14"> 
                      <div class="text-xs font-bold leading-normal truncate"
                          [class.text-green-400]="war?.warEval == 0"
                          [class.text-red-400]="war?.warEval == 1"
                          [class.text-slate-400]="getFameText(war) == 'N/A'">
                        {{ getFameText(war) }}@if (isPartialParticipation(war)) {<span class="text-[12px] text-slate-400 ml-0.5">{{ getActiveWarDays(war) }}</span>}
                      </div>
                    </div>
                  }

                  <div class="w-12 border-l border-slate-700/50 ml-1">
                    <div class="text-xs font-bold leading-normal"
                        [class.text-green-400]="member.donationEval == 0"
                        [class.text-red-400]="member.donationEval == 1">
                      {{ member.donations }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </ng-template>

  } @else if (errorMessage) {
    <div class="p-8 text-center text-red-500">{{ errorMessage }}</div>
  } @else {
    <div class="p-8 text-center text-slate-400 animate-pulse">Loading Royale Data...</div>
  }
</div>
